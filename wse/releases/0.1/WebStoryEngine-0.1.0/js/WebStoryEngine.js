var Squiddle=function(a,b){"use strict";a=a||{log:function(){},dir:function(){}};b=b||{};var c,d;c=function(b){b=b||{};if(!(this instanceof c)){return new c(b)}this.debug=b.debug||false;this.interceptErrors=b.interceptErrors||false;this.log=b.log||false;this.logData=b.logData||false;this.callbacks={"*":[]};var d=this,e;e=function(b,c){if(d.debug!==true){return}var e=b.error.name||"Error";a.log(e+" in listener; Event: "+b.info.event+"; Message: "+b.error.message)};this.subscribe(e,"squiddle.error")};c.create=function(a){a=a||{};return new c(a)};c.prototype.subscribe=function(a,b){if(typeof b!=="undefined"&&typeof b!=="string"&&typeof b!=="number"){throw new Error("Event names can only be strings or numbers!")}if(typeof a!=="function"){throw new Error("Only functions may be used as listeners!")}b=b||"*";this.callbacks[b]=this.callbacks[b]||[];this.callbacks[b].push(a);this.trigger("squiddle.subscribe",{listener:a,event:b,bus:this})};c.prototype.unsubscribe=function(a,b){if(typeof b!=="undefined"&&typeof b!=="string"&&typeof b!=="number"){throw new Error("Event names can only be strings or numbers!")}b=b||"*";var c=this.callbacks[b]||[],d=c.length,e;for(e=0;e<d;++e){if(c[e]===a){this.callbacks[b].splice(e,1)}}this.trigger("squiddle.unsubscribe",{listener:a,event:b,bus:this})};c.prototype.trigger=function(b,c,e){if(typeof b!=="undefined"&&typeof b!=="string"&&typeof b!=="number"){throw new Error("Event names can only be strings or numbers!")}b=b||"*";c=c||null;e=e||true;e=e===false?false:true;var f,g,h,i,j,k,l=this;f=function(){var a,c,d,e,f,g,h="",i=[];c=b.split(".");for(a=0,d=c.length;a<d;++a){h=h+(a>0?".":"")+c[a];e=l.callbacks[h]||[];for(f=0,g=e.length;f<g;++f){i.push(e[f])}}if(b==="*"){return i}e=l.callbacks["*"]||[];for(f=0,g=e.length;f<g;++f){i.push(e[f])}return i}();g=f.length;h={event:b,subscribers:g,getQueueLength:function(){if(g===0){return 0}return g-(i+1)}};d=function(a){setTimeout(function(){throw a},0)};j=function(){if(l.log===true){a.log("Squiddle event triggered: "+b+"; Subscribers: "+g,l.logData===true?"; Data: "+c:"")}for(i=0;i<g;++i){k=f[i];try{k(c,h)}catch(e){a.log("Error is: "+e);l.trigger("squiddle.error",{error:e,info:h});if(l.interceptErrors!==true){d(e)}}}};if(e===true){setTimeout(j,0)}else{j()}};b.create=c;return c}(typeof console==="undefined"?false:console,typeof exports==="undefined"?false:exports);var console=console||{log:function(){}};window.requestAnimationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}();var MO5={};MO5.timers={};MO5.highestId=0;MO5.bus=new Squiddle;MO5.getUniqueId=function(){var a,b,c,d;a=255*Math.random();b=255*Math.random();c=255*Math.random();MO5.highestId+=1;d=MO5.highestId+parseInt(a*b*c);return d};MO5.transform=function(a,b,c,d){d=d||{};if(typeof a==="undefined"||!a){throw new Error("MO5.transform expects parameter callback to be a function.")}var e=d.duration||1e3,f,g,h=(new Date).getTime(),i,j=b,k=[],l,m=0,n=0,o=false,p=c-b,q=d.log||false,r=0,s=d.onFinish||function(){};if(!Date.now){f=function(){return+(new Date)}}else{f=Date.now}g=d.easing||MO5.easing.sineEaseOut;i=function(){var d,k,m;k=f();r+=1;d=f();n=d-h;if(n>e){j=b+p;a(c);clearInterval(l);delete MO5.timers[l];s();return}requestAnimationFrame(i);j=g(e,n)*p+b;a(j);m=f()-k;if(q===true){console.log("Current value: "+j+"; c: "+r+"; Exec time: "+m)}};l=MO5.getUniqueId();requestAnimationFrame(i);MO5.timers[l]=true;return l};MO5.createTimer=function(a){var b;a=a||0;a=a<0?0:a;b=setTimeout(function(){delete MO5.timers[b]},a);MO5.timers[b]=true;return b};MO5.getWindowDimensions=function(){var a=window,b="inner";if(!("innerWidth"in a)){b="client";a=document.documentElement||document.body}return{width:a[b+"Width"],height:a[b+"Height"]}};MO5.Point=function(a,b){this.x=a;this.y=b};MO5.Point.prototype.getDistance=function(a){var b=this.x-a.x,c=this.y-a.y,d=Math.squrt(b*b+c*c);return d};MO5.easing={};MO5.easing.linear=function(a,b){return b/a};MO5.easing.sineEaseOut=function(a,b){var c=Math.PI/(2*a);var d=Math.abs(Math.sin(b*c));return d};MO5.easing.sineEaseIn=function(a,b){var c=Math.PI/(2*a);var d=Math.abs(-Math.cos(b*c)+1);return d};MO5.easing.sineEaseInOut=function(a,b){if(b/(a/2)<1){return MO5.easing.sineEaseIn(a,b)}else{return MO5.easing.sineEaseOut(a,b)}};MO5.easing.easeOutBounce=function(a,b){var c=0,d=1;if((b/=a)<1/2.75){return d*7.5625*b*b+c}else if(b<2/2.75){return d*(7.5625*(b-=1.5/2.75)*b+.75)+c}else if(b<2.5/2.75){return d*(7.5625*(b-=2.25/2.75)*b+.9375)+c}else{return d*(7.5625*(b-=2.625/2.75)*b+.984375)+c}};MO5.easing.createEaseOutFunction=function(a){var b=function(b,c){return 1-Math.pow(1-c/b,a)};return b};MO5.easing.createEaseInFunction=function(a){var b=function(b,c){return Math.pow(c/b,a)};return b};MO5.easing.createEaseInOutFunction=function(a){var b,c,d;c=MO5.easing.createEaseInFunction(a);d=MO5.easing.createEaseOutFunction(a);b=function(a,b){var e;if(b>a/2){e=d(a,b)}else{e=c(a,b)}return e};return b};MO5.easing.easeOutQuad=MO5.easing.createEaseOutFunction(2);MO5.easing.easeOutCubic=MO5.easing.createEaseOutFunction(3);MO5.easing.easeOutQuart=MO5.easing.createEaseOutFunction(4);MO5.easing.easeOutQuint=MO5.easing.createEaseOutFunction(5);MO5.easing.easeInQuad=MO5.easing.createEaseInFunction(2);MO5.easing.easeInCubic=MO5.easing.createEaseInFunction(3);MO5.easing.easeInQuart=MO5.easing.createEaseInFunction(4);MO5.easing.easeInQuint=MO5.easing.createEaseInFunction(5);MO5.easing.easeInOutQuad=MO5.easing.createEaseInOutFunction(2);MO5.easing.easeInOutCubic=MO5.easing.createEaseInOutFunction(3);MO5.easing.easeInOutQuart=MO5.easing.createEaseInOutFunction(4);MO5.easing.easeInOutQuint=MO5.easing.createEaseInOutFunction(5);MO5.mixins={};MO5.mixins.display=function(){var a=this;this.canvas.addCallback(this.id,function(){a.draw()},this.layer||0,this)};MO5.mixins.hide=function(){this.canvas.removeCallback(this.id)};MO5.mixins.getCenter=function(){var a=this.x+this.width/2,b=this.y+this.height/2;return new MO5.Point(a,b)};MO5.mixins.change=function(a,b){this[a]=b;this.updated=true};MO5.mixins.moveTo=function(a,b,c){c=c||{};var d,e,f=this;d=MO5.transform(function(a){f.x=a},this.x,a,c);e=MO5.transform(function(a){f.y=a},this.y,b,c);return[d,e]};MO5.mixins.move=function(a,b,c){c=c||{};dx=this.x+a;dy=this.y+b;return this.moveTo(dx,dy,c)};MO5.mixins.fadeIn=function(a){a=a||{};var b=this;return MO5.transform(function(a){b.opacity=a},this.opacity,1,a)};MO5.mixins.fadeOut=function(a){a=a||{};var b=this;return MO5.transform(function(a){b.opacity=a},this.opacity,0,a)};MO5.Animation=function(a){if(!(this instanceof MO5.Animation)){return new MO5.Animation(a)}this.cbs=a.slice();this.isRunning=false;this.stopped=true;this.paused=false;this.timers={}};MO5.Animation.prototype.animate=function(a,b){b=b||function(){};var c=this,d=a.slice(),e=d.shift(),f,g,h,i;if(e===undefined){return b()}f=e();if(f===undefined){this.animate(d,b);return}g=f.length;for(h=0;h<g;++h){this.timers[f[h]]=MO5.timers[f[h]]}i=function(){c.animate(d,b)};this.onTimersFinished(f,i)};MO5.Animation.prototype.onTimersFinished=function(a,b){var c=a.length,d,e=this;for(d=0;d<c;++d){if(typeof MO5.timers[a[d]]!=="undefined"&&MO5.timers[a[d]]===true){setTimeout(function(){e.onTimersFinished(a,b)},20);return}}b()};MO5.Animation.prototype.run=function(){var a=this;if(this.isRunning===false){return}setTimeout(function(){if(this.stopped===true){return}if(this.paused===true){return a.run()}a.animate(a.cbs,function(){a.run()})},1)};MO5.Animation.prototype.start=function(){this.stopped=false;this.isRunning=true;this.run()};MO5.Animation.prototype.loop=function(a,b){var c=this;a=a||1;b=b||0;setTimeout(function(){b++;if(b>a){return}c.animate(c.cbs,function(){c.loop(a,b)})},20)};MO5.Animation.prototype.stop=function(a){var b=a||false,c,d=this;this.stopped=!b;if(b!==true){for(c in this.timers){clearInterval(c);if(typeof d.timers[c]!=="undefined"){delete d.timers[c]}}}this.isRunning=false};MO5.canvas={};MO5.canvas.PrototypeObject=function(){};MO5.canvas.PrototypeObject.prototype.move=MO5.mixins.move,MO5.canvas.PrototypeObject.prototype.moveTo=MO5.mixins.moveTo,MO5.canvas.PrototypeObject.prototype.fadeIn=MO5.mixins.fadeIn,MO5.canvas.PrototypeObject.prototype.fadeOut=MO5.mixins.fadeOut,MO5.canvas.PrototypeObject.prototype.display=MO5.mixins.display,MO5.canvas.PrototypeObject.prototype.hide=MO5.mixins.hide,MO5.canvas.PrototypeObject.prototype.getCenter=MO5.mixins.getCenter,MO5.canvas.PrototypeObject.prototype.change=MO5.mixins.change;MO5.canvas.Canvas=function(a){a=a||{};this.id=MO5.getUniqueId();var b=this,c=a.id||null,d=false;if(c===null){this.cv=document.createElement("canvas");this.cv.setAttribute("id","MO5Canvas"+this.id)}else{this.cv=document.getElementById(c)}this.ct=this.cv.getContext("2d");this.fps=a.fps||30;this.tbf=1/this.fps;this.time=0;this.sine=0;this.width=a.width||800;this.height=a.height||450;this.timerId;this.functions=[];this.functionsByKey={};this.functionsByPriority=[];this.scale=a.scale||false;this.scaleX=a.scaleX||1;this.scaleY=a.scaleY||1;this.frozen=false;this.temp=document.createElement("canvas");this.stopped=true;this.bus=a.bus||MO5.bus;this.cv.width=this.width;this.cv.height=this.height;this.temp.width=this.width;this.temp.height=this.height;document.body.appendChild(this.cv);this.draw=function(){if(b.stopped===false){requestAnimationFrame(b.draw)}var a=b.tbf;b.time+=a;var c,e,f,g,h,i=b.time,j=b.functions,k=b.cv,l=b.ct,m,n;if(b.frozen===true&&d===true){l.drawImage(b.temp,0,0);return}else if(b.frozen===false&&d===true){d=false}b.sine=(Math.sin(i)+1)/2;e={context:l,canvas:k,fps:b.fps,tbf:a,time:i,sine:b.sine};l.clearRect(0,0,k.width,k.height);g=j.length;for(h=0;h<g;++h){j[h]["callback"](e)}if(b.frozen===true){b.temp.clearRect(0,0,b.width,b.height);b.temp.drawImage(k,0,0);d=true}}};MO5.canvas.Canvas.prototype.addCallback=function(a,b,c){var d=this.functionsByPriority,e={key:a,callback:b,priority:c||0};if(typeof d[c]=="undefined"||d[c]===null){this.functionsByPriority[c]=[]}this.functionsByPriority[c].push(e);this.functionsByKey[a]=e;this.rebuildFunctionQueue()};MO5.canvas.Canvas.prototype.rebuildFunctionQueue=function(){var a,b,c,d,e;this.functions=[];a=this.functionsByPriority.length;for(c=0;c<a;++c){if(typeof this.functionsByPriority[c]=="undefined"){continue}b=this.functionsByPriority[c];e=b.length;for(d=0;d<e;++d){this.functions.push(b[d])}}};MO5.canvas.Canvas.prototype.removeCallback=function(a){if(typeof this.functionsByKey[a]=="undefined"){return}var b=this.functionsByKey[a],c=b.priority,d=this.functionsByPriority[c],e=d.length,f;for(f=0;f<e;++f){if(d[f].key!==a){continue}this.functionsByPriority[c].splice(f,1)}this.rebuildFunctionQueue();delete this.functionsByKey[a]};MO5.canvas.Canvas.prototype.start=function(){this.stopped=false;this.draw()};MO5.canvas.Canvas.prototype.stop=function(){this.stopped=true};MO5.canvas.Canvas.prototype.fitToWindow=function(a){var b=MO5.getWindowDimensions(),c=this.cv,d=b.width,e=b.height,f="",g="width",h=this.width/this.height,i=d/h,j=e*h,k=d/e,a=a||false;if(a===true&&d>=this.width&&e>=this.height){return}if(h<k){i=e}else{j=d}c.setAttribute("style"," width: "+j+"px; height: "+i+"px; margin: auto; position: absolute;"+" left: "+(d-j)/2+"px; top: "+(e-i)/2+"px;")};MO5.canvas.Canvas.prototype.center=function(){var a=MO5.getWindowDimensions(),b=this.cv,c=a.width,d=a.height,e=this.height,f=this.width;b.setAttribute("style","position: absolute; left: "+(c-f)/2+"px; top: "+(d-e)/2+"px;")};MO5.canvas.ImagePack=function(a,b){b=b||{};if(!(this instanceof MO5.canvas.ImagePack)){return new MO5.canvas.ImagePack(a,b)}this.images={};this.current=null;this.x=b.x||0;this.y=b.y||0;this.id=MO5.getUniqueId();this.canvas=a;this.layer=b.layer||0;this.alpha=b.alpha||1;this.rotation=b.rotation||0;this.pivotX=b.pivotX||this.x;this.pivotY=b.pivotY||this.y;this.shadowX=b.shadowX||5;this.shadowY=b.shadowY||5;this.shadowBlur=b.shadowBlur||5;this.shadowColor=b.shadowColor||"rgba(0, 0, 0, 0.5)";this.hasShadow=b.hasShadow||false;this.updated=true};MO5.canvas.ImagePack.prototype=new MO5.canvas.PrototypeObject;MO5.canvas.ImagePack.prototype.draw=function(a){var b=this,c=b.canvas.ct,d=b.x,e=b.y,f=b.width,g=b.height,h=b.rotation,i=b.pivotX,j=b.pivotY;if(b.current===null){throw new Error("You need to use set() before this method!")}c.save();c.globalAlpha=b.alpha;if(h>0){c.translate(i,j);c.rotate(Math.PI*h/180);c.translate(-i,-j)}if(b.hasShadow===true){c.shadowOffsetX=b.shadowX;c.shadowOffsetY=b.shadowY;c.shadowBlur=b.shadowBlur;c.shadowColor=b.shadowColor}c.drawImage(b.current,.5+d|0,.5+e|0);c.restore()};MO5.canvas.ImagePack.prototype.addImage=function(a,b){var c=new Image;c.src=b;this.images[a]=c};MO5.canvas.ImagePack.prototype.removeImage=function(a){delete this.images[a]};MO5.canvas.ImagePack.prototype.set=function(a){if(typeof this.images[a]=="undefined"){throw new Error("This ImagePack doesn't have such an image.")}this.current=this.images[a];this.width=this.current.width;this.height=this.current.height;this.pivotX=this.x+this.width/2;this.pivotY=this.y+this.height/2};MO5.canvas.ImagePack.prototype.animate=function(a){a=a||{};var b=a.names||null,c=[],d,e=a.duration||1e3,f=this,g,h,i,j=[];if(b===null){d=this.images}else{for(h=0,g=b.length;h>g;++h){if(typeof this.images[b[h]]==="undefined"){throw new Error("No such image in this ImagePack.")}d[b[h]]=this.images[b[h]]}}for(i in d){if(!d.hasOwnProperty(i)){continue}j.push(d[i])}c.push(function(){var a=MO5.transform(function(a){a=.5+a|0;if(typeof j[a]==="undefined"||j[a]===null){console.log("No such image: "+a);return}f.current=j[a]},0,j.length-1,{duration:e,"function":MO5.easing.linear});return[a]});return new MO5.Animation(c)};MO5.canvas.TextBox=function(a,b){b=b||{};if(!(this instanceof MO5.canvas.TextBox)){return new MO5.canvas.TextBox(a,b)}var c=this,d=[],e="";this.lastText="";this.lines=[];this.id=MO5.getUniqueId();this.canvas=a;this.width=a.cv.width;this.height=a.cv.height;this.layer=b.layer||0;this.alpha=b.alpha||1;this.x=b.x||0;this.y=b.y||0;this.rotation=b.rotation||0;this.pivotX=b.pivotX||this.x+this.width/2;this.pivotY=b.pivotY||this.y+this.height/2;this.text=b.text||"";this.lineHeight=18;this.color="#fff";this.font=b.font||"bold 15px Arial, Helvetica, sans-serif";this.align=b.align||"left";this.shadowX=b.shadowX||2;this.shadowY=b.shadowY||2;this.shadowBlur=b.shadowBlur||2;this.shadowColor=b.shadowColor||"rgba(0, 0, 0, 0.5)";this.hasShadow=b.hasShadow||false;this.updated=true};MO5.canvas.TextBox.prototype=new MO5.canvas.PrototypeObject;MO5.canvas.TextBox.prototype.draw=function(a){var b=this,c=b.canvas.ct,d=b.text.split(" "),e="",f="",g=d.length,h,i=0,j;c.save();c.globalAlpha=b.alpha;if(b.rotation>0){c.translate(b.pivotX,b.pivotY);c.rotate(Math.PI*b.rotation/180);c.translate(-b.pivotX,-b.pivotY)}if(b.hasShadow===true){c.shadowOffsetX=b.shadowX;c.shadowOffsetY=b.shadowY;c.shadowBlur=b.shadowBlur;c.shadowColor=b.shadowColor}c.fillStyle=b.color;c.font=b.font;c.textAlign=b.align;if(this.text!==b.lastText){b.lines=[];for(h=0;h<g;++h){e=d[h];if(c.measureText(f+" "+e).width>b.width){b.lines.push(f);f=""}f=f+" "+e;if(h===g-1){b.lines.push(f)}}}j=b.lines.length;for(h=0;h<j;++h){c.fillText(b.lines[h],.5+b.x|0,.5+(b.y+b.lineHeight*h)|0)}b.lastText=b.text;b.canvas.ct.restore()};MO5.canvas.Rectangle=function(a,b){b=b||{};if(!(this instanceof MO5.canvas.Rectangle)){return new MO5.canvas.Rectangle(a,b)}var c=this;this.id=MO5.getUniqueId();this.canvas=a;this.width=b.width||a.cv.width;this.height=b.height||a.cv.height;this.layer=b.layer||0;this.alpha=b.alpha||1;this.x=b.x||0;this.y=b.y||0;this.rotation=b.rotation||0;this.pivotX=b.pivotX||this.x+this.width/2;this.pivotY=b.pivotY||this.y+this.height/2;this.color=b.color||"#fff";this.borderColor=b.borderColor||"#000";this.borderWidth=b.borderWidth||0;this.shadowX=b.shadowX||5;this.shadowY=b.shadowY||5;this.shadowBlur=b.shadowBlur||5;this.shadowColor=b.shadowColor||"rgba(0, 0, 0, 0.5)";this.hasShadow=b.hasShadow||false};MO5.canvas.Rectangle.prototype=new MO5.canvas.PrototypeObject;MO5.canvas.Rectangle.prototype.draw=function(a){var b=this,c=b.canvas.ct,d=b.x,e=b.y,f=b.width,g=b.height,h=b.rotation,i=b.pivotX,j=b.pivotY;c.save();c.globalAlpha=b.alpha;if(h>0){c.translate(i,j);c.rotate(Math.PI*h/180);c.translate(-i,-j)}if(b.hasShadow===true){c.shadowOffsetX=b.shadowX;c.shadowOffsetY=b.shadowY;c.shadowBlur=b.shadowBlur;c.shadowColor=b.shadowColor}c.fillStyle=b.color;c.fillRect(d,e,f,g);if(b.borderWidth>0){c.strokeStyle=b.borderColor;c.lineWidth=b.borderWidth;c.strokeRect(d,e,f,g)}c.restore()};MO5.canvas.Rain=function(a,b){b=b||{};if(!(this instanceof MO5.canvas.Rain)){return new MO5.canvas.Rain(a,b)}var c=this;this.id=MO5.getUniqueId();this.canvas=a;this.width=b.width||a.cv.width*2;this.height=b.height||a.cv.height*2;this.layer=b.layer||0;this.alpha=b.alpha||1;this.rotation=b.rotation||0;this.pivotX=b.pivotX||this.canvas.cv.width/2;this.pivotY=b.pivotY||this.canvas.cv.height/2;this.color=b.color||"#fff";this.drops=b.drops||100;this.data=null;this.speed=b.speed||20;this.x=b.x||(this.width-a.cv.width)/2;this.y=b.y||(this.height-a.cv.height)/2;this.lastDrawTime=0;this.canvas.bus.subscribe(function(){c.hide()},"mo5.canvas.rain.hideAll");this.canvas.bus.subscribe(function(){c.display()},"mo5.canvas.rain.displayAll")};MO5.canvas.Rain.prototype=new MO5.canvas.PrototypeObject;MO5.canvas.Rain.prototype.draw=function(a){var b=this,c=b.canvas.ct,d=b.drops,e,f=b.data,g,h,i,j=b.width,k=b.height,l;c.save();c.globalAlpha=b.alpha;if(b.rotation>0){c.translate(b.pivotX,b.pivotY);c.rotate(Math.PI*b.rotation/180);c.translate(-b.pivotX,-b.pivotY)}if(f===null){f=[];for(e=0;e<d;++e){g=Math.random()*j-(b.width-b.canvas.cv.width)/2;h=Math.random()*k-(b.height-b.canvas.cv.height)/2;i=Math.random()*40+5;f.push({x:g,fy:h,ly:i})}}c.strokeStyle=b.color;c.lineWidth=1;c.beginPath();for(e=0;e<d;++e){l=f[e];l.fy+=b.speed;if(l.fy>b.canvas.cv.height+l.ly){l.fy=0-(b.height-b.canvas.cv.height)/2-l.ly;l.x=Math.random()*j-(b.width-b.canvas.cv.width)/2}c.moveTo(l.x,l.fy);c.lineTo(l.x,l.fy+l.ly);c.moveTo(l.x-1,l.fy+2*(l.ly/3));c.lineTo(l.x-1,l.fy+l.ly);f[e]=l}c.stroke();c.closePath();c.restore();b.data=f};MO5.canvas.Rain.prototype.display=MO5.mixins.display;MO5.canvas.Rain.prototype.hide=MO5.mixins.hide;MO5.canvas.Rain.prototype.getCenter=MO5.mixins.getCenter;MO5.canvas.Rain.prototype.fadeIn=MO5.mixins.fadeIn;MO5.canvas.Rain.prototype.fadeOut=MO5.mixins.fadeOut;MO5.canvas.PixelManipulator=function(a,b){b=b||{};if(!(this instanceof MO5.canvas.PixelManipulator)){return new MO5.canvas.PixelManipulator(a,b)}var c=this;this.id=MO5.getUniqueId();this.canvas=a;this.width=b.width||a.cv.width;this.height=b.height||a.cv.height;this.layer=b.layer||0;this.alpha=b.alpha||1;this.rotation=b.rotation||0;this.pivotX=b.pivotX||this.canvas.cv.width/2;this.pivotY=b.pivotY||this.canvas.cv.height/2;this.x=b.x||0;this.y=b.y||0;this.data=this.canvas.ct.createImageData(this.width,this.height);this.lastWidth=this.width;this.lastHeight=this.height;this.isChanged=true;this.img=new Image;this.draw=function(a){var b=c.canvas.ct,d=c.data,e,f=document.createElement("canvas"),g=f.getContext("2d"),h;b.save();b.globalAlpha=c.alpha;if(c.rotation>0){b.translate(c.pivotX,c.pivotY);b.rotate(Math.PI*c.rotation/180);b.translate(-c.pivotX,-c.pivotY)}if(this.isChanged===false){b.drawImage(c.img,c.x,c.y);b.restore();return}this.isChanged=false;if(c.lastWidth!==c.width||c.lastHeight!==c.height){d=b.createImageData(c.width,c.height)}f.width=c.width;f.height=c.height;g.putImageData(d,c.x,c.y);c.img.src=f.toDataURL();b.drawImage(c.img,c.x,c.y);b.restore();c.data=d}};MO5.canvas.PixelManipulator.prototype.setPixel=function(a,b,c,d,e,f){var g=(a+b*this.width)*4,h=this.data.data;h[g]=c;h[g+1]=d;h[g+2]=e;h[g+3]=f;this.isChanged=true};MO5.canvas.PixelManipulator.prototype.display=MO5.mixins.display;MO5.canvas.PixelManipulator.prototype.hide=MO5.mixins.hide;MO5.canvas.PixelManipulator.prototype.getCenter=MO5.mixins.getCenter;MO5.canvas.PixelManipulator.prototype.moveTo=MO5.mixins.moveTo;MO5.canvas.PixelManipulator.prototype.move=MO5.mixins.move;MO5.canvas.PixelManipulator.prototype.fadeIn=MO5.mixins.fadeIn;MO5.canvas.PixelManipulator.prototype.fadeOut=MO5.mixins.fadeOut;MO5.dom={};MO5.dom.PrototypeObject=function(){};MO5.dom.PrototypeObject.prototype.fadeIn=function(a){a=a||{};var b=this.node;return MO5.transform(function(a){b.style.opacity=a},0,1,a)};MO5.dom.PrototypeObject.prototype.fadeOut=function(a){a=a||{};var b=this.node;return MO5.transform(function(a){b.style.opacity=a},1,0,a)};MO5.dom.PrototypeObject.prototype.moveTo=function(a,b,c){c=c||{};var d=this.node,e=d.offsetLeft,f=d.offsetTop,g,h;g=MO5.transform(function(a){d.style.left=a+"px"},e,a,c);h=MO5.transform(function(a){d.style.top=a+"px"},f,b,c);return[g,h]};MO5.dom.PrototypeObject.prototype.move=function(a,b,c){c=c||{};var d=this.node,e=d.offsetLeft+a,f=d.offsetTop+b;return this.moveTo(e,f,c)};MO5.dom.PrototypeObject.prototype.display=function(){var a;try{a=this.parent||document.getElementsByTagName("body")[0];a.appendChild(this.node)}catch(b){}};MO5.dom.PrototypeObject.prototype.hide=function(){var a;try{a=this.parent||document.getElementsByTagName("body")[0];a.removeChild(this.node)}catch(b){}};MO5.dom.Node=function(a){a=a||{};if(!(this instanceof MO5.dom.Node)){return new MO5.dom.Node(node,a)}this.parent=a.parent||document.getElementsByTagName("body")[0];this.nodeType=a.nodeType||"div";this.node=a.node||document.createElement(this.nodeType);this.bus=a.bus||MO5.bus;this.bus.trigger("mo5.dom.node.create",this)};MO5.dom.Node.prototype=new MO5.dom.PrototypeObject;MO5.dom.Node.prototype.constructor=MO5.dom.Node;MO5.dom.ImagePack=function(a){a=a||{};if(!(this instanceof MO5.dom.ImagePack)){return new MO5.dom.ImagePack(node,a)}this.parent=a.parent||document.getElementsByTagName("body")[0];this.nodeType=a.nodeType||"div";this.node=a.node||document.createElement(this.nodeType);this.bus=a.bus||MO5.bus;this.bus.trigger("mo5.dom.imagepack.create",this)};MO5.dom.ImagePack.prototype=new MO5.dom.PrototypeObject;var console=console||{log:function(){}};var STEINBECK=STEINBECK||{};STEINBECK.Keys=function(a){a=a||{};if(!(this instanceof STEINBECK.Keys)){return new STEINBECK.Keys(a)}this.keys={};this.keys.BACKSPACE={kc:8};this.keys.TAB={kc:9};this.keys.ENTER={kc:13,which:13};this.keys.SHIFT={kc:16};this.keys.CTRL={kc:17};this.keys.ALT={kc:18};this.keys.PAUSE={kc:19};this.keys.CAPS_LOCK={kc:20};this.keys.ESCAPE={kc:27};this.keys.SPACE={kc:32};this.keys.PAGE_UP={kc:33};this.keys.PAGE_DOWN={kc:20};this.keys.END={kc:20};this.keys.HOME={kc:20};this.keys.LEFT_ARROW={kc:37};this.keys.UP_ARROW={kc:38};this.keys.RIGHT_ARROW={kc:39};this.keys.DOWN_ARROW={kc:40};this.keys.INSERT={kc:45};this.keys.DELETE={kc:46};this.keys.NUM_0={kc:48};this.keys.NUM_1={kc:49};this.keys.NUM_2={kc:50};this.keys.NUM_3={kc:51};this.keys.NUM_4={kc:52};this.keys.NUM_5={kc:53};this.keys.NUM_6={kc:54};this.keys.NUM_7={kc:55};this.keys.NUM_8={kc:56};this.keys.NUM_9={kc:57};this.keys.A={kc:65};this.keys.B={kc:66};this.keys.C={kc:67};this.keys.D={kc:68};this.keys.E={kc:69};this.keys.F={kc:70};this.keys.G={kc:71};this.keys.H={kc:72};this.keys.I={kc:73};this.keys.J={kc:74};this.keys.K={kc:75};this.keys.L={kc:76};this.keys.M={kc:77};this.keys.N={kc:78};this.keys.O={kc:79};this.keys.P={kc:80};this.keys.Q={kc:81};this.keys.R={kc:82};this.keys.S={kc:83};this.keys.T={kc:84};this.keys.U={kc:85};this.keys.V={kc:86};this.keys.W={kc:87};this.keys.X={kc:88};this.keys.Y={kc:89};this.keys.Z={kc:90};this.keys.LEFT_WIN={kc:91};this.keys.RIGHT_WIN={kc:92};this.keys.SELECT={kc:93};this.keys.NUMPAD_0={kc:96};this.keys.NUMPAD_1={kc:97};this.keys.NUMPAD_2={kc:98};this.keys.NUMPAD_3={kc:99};this.keys.NUMPAD_4={kc:100};this.keys.NUMPAD_5={kc:101};this.keys.NUMPAD_6={kc:102};this.keys.NUMPAD_7={kc:103};this.keys.NUMPAD_8={kc:104};this.keys.NUMPAD_9={kc:105};this.keys.MULTIPLY={kc:106};this.keys.ADD={kc:107};this.keys.SUBSTRACT={kc:109};this.keys.DECIMAL_POINT={kc:110};this.keys.DIVIDE={kc:111};this.keys.F1={kc:112};this.keys.F2={kc:113};this.keys.F3={kc:114};this.keys.F4={kc:115};this.keys.F5={kc:116};this.keys.F6={kc:117};this.keys.F7={kc:118};this.keys.F8={kc:119};this.keys.F9={kc:120};this.keys.F10={kc:121};this.keys.F11={kc:122};this.keys.F12={kc:123};this.keys.NUM_LOCK={kc:144};this.keys.SCROLL_LOCK={kc:145};this.keys.SEMI_COLON={kc:186};this.keys.EQUALS={kc:187};this.keys.COMMA={kc:188};this.keys.DASH={kc:189};this.keys.PERIOD={kc:190};this.keys.SLASH={kc:191};this.keys.GRAVE={kc:192};this.keys.OPEN_BRACKET={kc:219};this.keys.BACK_SLASH={kc:220};this.keys.CLOSE_BRACKET={kc:221};this.keys.SINGLE_QUOTE={kc:222};this.listeners=[];var b,c,d,e,f,g,h=a.log||false,i=a.element||window,j=this;b=function(a){if(a==null||typeof a=="undefined"){return}if(a.addEventListener){a.addEventListener("keyup",d,false);a.addEventListener("keydown",e,false);a.addEventListener("keypress",f,false);if(h===true){a.addEventListener("keyup",g,false);a.addEventListener("keydown",g,false);a.addEventListener("keypress",g,false)}}else if(a.attachEvent){a.attachEvent("onkeyup",d);a.attachEvent("onkeydown",e);a.attachEvent("onkeypress",f);if(h===true){a.attachEvent("onkeyup",g);a.attachEvent("onkeydown",g);a.attachEvent("onkeypress",g)}}};c=function(a,b){var c=j.listeners.length,d,e;for(e=0;e<c;++e){d=j.listeners[e];if(typeof d=="undefined"||d.type!=b){continue}d.key=d.key||{};kc=d.key.kc||null;which=d.key.which||null;if(a.which==which||a.keyCode==kc){d.callback(a)}}};d=function(a){c(a,"up")};e=function(a){c(a,"down")};f=function(a){c(a,"press")};g=function(a){console.log(a)};b(i)};STEINBECK.Keys.prototype.addListener=function(a,b,c){c=c||"up";if(c!=="up"&&c!=="down"&&c!=="press"){throw new Error("Event type not recognized.")}this.listeners.push({key:a,callback:b,type:c})};STEINBECK.Keys.prototype.removeListener=function(a,b,c){c=c||null;var d=this.listeners.length;var e;for(var f=0;f<d;++f){e=this.listeners[f];if(c!==null&&e.type!=c){continue}if(typeof e!=="undefined"&&e.key===a&&e.callback===b){delete this.listeners[f]}}};STEINBECK.Keys.prototype.forAll=function(a,b){b=b||"up";if(b!=="up"&&b!=="down"&&b!=="press"){throw new Error("Event type not recognized.")}for(var c in this.keys){if(!this.keys.hasOwnProperty(c)){continue}this.addListener(this.keys[c],a,b)}};var WSE=function(a,b,c){"use strict";var d={};d.fx=b;d.Keys=c.Keys;d.ajax={};d.ajax.get=function(a,b){a=a+"?random="+Math.random();var c=new XMLHttpRequest;c.onreadystatechange=function(){if(c.readyState===4&&c.status===200){b(c)}if(c.readyState===4&&c.status!==200){throw new Error("WSE: Cannot load XML file.")}};if(c.overrideMimeType){c.overrideMimeType("text/xml")}c.open("GET",a,true);c.send()};d.Game=function(b){b=b||{};this.bus=new a;this.url=b.url||"game.xml";this.ws=null;this.load(this.url);this.interpreter=new d.Interpreter(this);this.keys=new d.Keys;this.bus.subscribe(function(a){console.log("Message: "+a)},"wse.interpreter.message");this.bus.subscribe(function(a){console.log("Error: "+a.message)},"wse.interpreter.error");this.bus.subscribe(function(a){console.log("Warning: "+a.message,a.element)},"wse.interpreter.warning")};d.Game.prototype.load=function(a){var b,c;c=this;b=function(a){c.ws=a.responseXML;c.init()};d.ajax.get(this.url,b)};d.Game.prototype.init=function(){var a,b,c,e,f,g,h,i,j;i=this;a=this.ws;c=a.getElementsByTagName("stage");f="800px";g="480px";h="Stage";if(c.length<1){throw new Error("No stage definition found!")}e=c[0];f=e.getAttribute("width")||f;g=e.getAttribute("height")||g;h=e.getAttribute("id")||h;if(e.getAttribute("create")==="yes"){b=document.createElement("div");b.setAttribute("id",h);document.body.appendChild(b)}else{b=document.getElementById(h)}j=function(){var a=d.fx.getWindowDimensions();b.style.left=a.width/2-parseInt(f,10)/2+"px";b.style.top=a.height/2-parseInt(g,10)/2+"px"};b.style.width=f;b.style.height=g;if(e.getAttribute("center")==="yes"){d.tools.attachEventListener(window,"resize",j);j()}this.stage=b};d.Game.prototype.start=function(){var a,b;b=this;if(this.ws===null){return setTimeout(function(){b.start()})}this.next=function(){b.bus.trigger("wse.game.next",this);b.interpreter.next(true)};a=function(){b.interpreter.next()};this.subscribeListeners=function(){d.tools.attachEventListener(this.stage,"click",a);this.keys.addListener(this.keys.keys.RIGHT_ARROW,this.next);this.keys.addListener(this.keys.keys.SPACE,this.next)};this.unsubscribeListeners=function(){d.tools.removeEventListener(this.stage,"click",a);this.keys.removeListener(this.keys.keys.RIGHT_ARROW,this.next);this.keys.removeListener(this.keys.keys.SPACE,this.next)};this.interpreter.start()};d.Interpreter=function(a){if(!(this instanceof d.Interpreter)){return new d.Interpreter(a)}this.game=a;this.assets={};this.index=0;this.visitedScenes=[];this.log=[];this.waitForTimer=false;this.assetsLoading=0;this.assetsLoadingMax=0;this.assetsLoaded=0};d.Interpreter.prototype.buildLoadingScreen=function(){var a,b,c,d;c=this;a=document.createElement("div");a.setAttribute("id","WSELoadingScreen");a.style.zIndex=1e4;a.style.width="100%";a.style.height="100%";a.innerHTML=""+'<div class="container">'+'<div class="heading"><span id="WSELoadingScreenPercentage"></span>Loading assets...</div>'+'<div class="progressBar">'+'<div class="progress" id="WSELoadingScreenProgress" style="width: 100%;">'+"</div>"+"</div>"+"</div>"+"";this.game.stage.appendChild(a);d=function(){var a,b,d;try{a=document.getElementById("WSELoadingScreenProgress");b=document.getElementById("WSELoadingScreenPercentage");d=parseInt(c.assetsLoaded/c.assetsLoadingMax*100,10);if(c.assetsLoadingMax<1){d=0}a.style.width=d+"%";b.innerHTML=""+c.assetsLoaded+"/"+c.assetsLoadingMax+" ("+d+"%)"}catch(e){console.log("Element missing.")}};this.bus.subscribe(d,"wse.assets.loading.increase");this.bus.subscribe(d,"wse.assets.loading.decrease");this.loadScreen=a};d.Interpreter.prototype.start=function(){this.story=this.game.ws;this.stage=this.game.stage;this.bus=this.game.bus;this.index=0;this.currentElement=0;this.sceneId=null;this.commans=[];this.wait=false;var a,b;a=this;this.buildLoadingScreen();b=function(b){var c,d,e;b=b||{};d=b.element||null;c=null;if(d!==null){try{c=b.element.tagName==="asset"?"assets":null;c=b.element.parent.tagName==="settings"?"settings":null}catch(f){}}c=c||"scenes";switch(c){case"assets":e="         Encountered in section 'assets'.";break;case"settings":e="         Encountered in section 'settings'.";break;default:e="         Encountered in scene '"+a.sceneId+"', element "+a.currentElement+".";break}console.log(e)};this.bus.subscribe(b,"wse.interpreter.error");this.bus.subscribe(b,"wse.interpreter.warning");this.bus.subscribe(function(){console.log("Game over.")},"wse.interpreter.end");this.bus.subscribe(function(){a.numberOfFunctionsToWaitFor+=1},"wse.interpreter.numberOfFunctionsToWaitFor.increase");this.bus.subscribe(function(){a.numberOfFunctionsToWaitFor-=1},"wse.interpreter.numberOfFunctionsToWaitFor.decrease");this.bus.subscribe(function(){a.assetsLoading+=1;a.assetsLoadingMax+=1},"wse.assets.loading.increase");this.bus.subscribe(function(){a.assetsLoading-=1;a.assetsLoaded+=1},"wse.assets.loading.decrease");this.bus.subscribe(function(){document.getElementById("WSELoadingScreenProgress").style.width="100%";d.fx.transform(function(b){a.loadScreen.style.opacity=b},1,0,{duration:500,onFinish:function(){a.loadScreen.style.display="none"}});console.log("Hiding loading screen...")},"wse.assets.loading.finished");this.buildAssets();setTimeout(function(){a.runStory()},1e3)};d.Interpreter.prototype.runStory=function(){var a,b,c,d,e;e=this;if(this.assetsLoading>0){return setTimeout(function(){e.runStory()},100)}this.bus.trigger("wse.assets.loading.finished");a=this.story.getElementsByTagName("scene");this.scenes=a;b=a.length;for(c=0;c<b;c+=1){d=a[c];if(d.getAttribute("id")==="start"){this.changeScene(d);return}}if(b<1){this.bus.trigger("wse.interpreter.error",{message:"No scenes found!"});return}this.changeScene(a[0])};d.Interpreter.prototype.changeScene=function(a){var b,c,d,e,f;if(typeof a==="undefined"||a===null){this.bus.trigger("wse.interpreter.error",{message:"Scene does not exist."});return}f=a.getAttribute("id");this.visitedScenes.push(f);if(f===null){this.bus.trigger("wse.interpreter.error",{message:"Encountered scene without id attribute."});return}this.bus.trigger("wse.interpreter.message","Entering scene '"+f+"'.");this.commands=a.childNodes;c=this.commands.length;this.index=0;this.sceneId=f;this.currentElement=0;if(c<1){this.bus.trigger("wse.interpreter.warning",{element:a,message:"Scene '"+f+"' is empty."});return}this.numberOfFunctionsToWaitFor=0;this.next()};d.Interpreter.prototype.next=function(a){var b,c,d,e,f;this.game.unsubscribeListeners();a=a===true?true:false;e=this;if(this.waitForTimer===true||this.wait===true&&this.numberOfFunctionsToWaitFor>0){setTimeout(function(){e.next()},10);return}if(this.wait===true&&this.numberOfFunctionsToWaitFor<1){this.wait=false;this.game.subscribeListeners()}if(this.index>=this.commands.length){this.bus.trigger("wse.interpreter.end",this);return}c=this.commands[this.index];b=c.nodeName;if(b==="#text"||b==="#comment"){this.index+=1;setTimeout(function(){e.next()},0);return}this.bus.trigger("wse.interpreter.next",c);this.currentElement+=1;d=this.runCommand(this.commands[this.index]);d=d||{};d.doNext=typeof d.doNext!=="undefined"&&d.doNext===false?false:true;d.wait=d.wait===true?true:false;d.changeScene=d.changeScene||null;if(d.wait===true){this.wait=true}this.index+=1;if(d.changeScene!==null){this.changeScene(d.changeScene);return}if(d.doNext===true){setTimeout(function(){e.next()},0);return}};d.Interpreter.prototype.runCommand=function(a){var b;b=a.tagName;switch(b){case"do":return this.runDoCommand(a);case"line":return this.runLineCommand(a);case"goto":return this.runGotoCommand(a);case"choice":return this.runChoiceCommand(a);case"wait":return this.runWaitCommand(a);case"stop":this.game.subscribeListeners();return{doNext:false,wait:true};default:this.bus.trigger("wse.interpreter.warning",{element:a,message:"Unknown element '"+b+"'."});return{doNext:true}}};d.Interpreter.prototype.runWaitCommand=function(a){var b,c;c=this;b=a.getAttribute("duration");if(b!==null){b=parseInt(b,10);this.waitForTimer=true;setTimeout(function(){c.waitForTimer=false},b);return{doNext:true,wait:false}}return{doNext:true,wait:true}};d.Interpreter.prototype.runChoiceCommand=function(a){var b,c,e,f,g,h,i,j,k,l,m,n,o,p,q;c=[];k=[];l=this;e=a.getElementsByTagName("option");f=e.length;i=a.getAttribute("duration")||500;i=parseInt(i,10);q=function(a,b){return function(){setTimeout(function(){l.changeScene(a)},0);l.stage.removeChild(b)}};if(f<1){this.bus.trigger("wse.interpreter.warning",{element:a,message:"Element 'choice' is empty. Expected at least one 'option' element."})}b=document.createElement("div");b.setAttribute("class","menu");for(g=0;g<f;g+=1){h=e[g];j=document.createElement("div");j.setAttribute("class","button");try{j.innerHTML=h.childNodes[0].nodeValue}catch(r){this.bus.trigger("wse.interpreter.warning",{element:a,message:"Element 'option' is empty."})}p=h.getAttribute("scene");for(m=0,n=this.scenes.length;m<n;m+=1){o=this.scenes[m];if(o.getAttribute("id")===p){k[g]=o;break}}d.tools.attachEventListener(j,"click",q(k[g],b));c.push(j);b.appendChild(j)}b.style.opacity=0;this.stage.appendChild(b);this.bus.trigger("wse.interpreter.numberOfFunctionsToWaitFor.increase");d.assets.mixins.show(a,{element:b,bus:this.bus,stage:this.stage});return{doNext:false,wait:true}};d.Interpreter.prototype.runGotoCommand=function(a){var b,c,d,e,f;c=a.getAttribute("scene");if(c===null){this.bus.trigger("wse.interpreter.error",{message:"Element 'goto' misses attribute 'scene'."})}for(d=0,e=this.scenes.length;d<e;d+=1){f=this.scenes[d];if(f.getAttribute("id")===c){b=f;break}}if(typeof b==="undefined"){this.bus.trigger("wse.interpreter.error",{message:"Unknown scene '"+c+"'."});return}return{changeScene:b}};d.Interpreter.prototype.runLineCommand=function(a){var b,c,d,e,f,g,h,i,j;this.game.subscribeListeners();b=a.getAttribute("s");j=a.getAttribute("stop")==="false"?true:false;if(b===null){this.bus.trigger("wse.interpreter.warning",{element:a,message:"Element 'line' requires attribute 's'."});return{doNext:true}}h=this.story.getElementsByTagName("asset");f=h.length;for(e=0;e<f;e+=1){g=h[e];if(g.getAttribute("type")==="character"&&g.getAttribute("name")===b){d=g.getAttribute("textbox");if(typeof d==="undefined"||d===null){this.bus.trigger("wse.interpreter.warning",{element:a,message:"No textbox defined for character '"+b+"'."});return{doNext:true}}try{c=g.getElementsByTagName("name")[0].childNodes[0].nodeValue}catch(k){}break}}if(typeof this.assets[d]==="undefined"){this.bus.trigger("wse.interpreter.warning",{element:a,message:"Trying to use an unknown textbox or character."});return{doNext:true}}i=a.childNodes[0].nodeValue;this.log.push({speaker:b,text:i});this.assets[d].put(i,c);return{doNext:j,wait:true}};d.Interpreter.prototype.runDoCommand=function(a,b){b=b||{};var c,d,e;c=a.getAttribute("asset");d=a.getAttribute("action");e=b.animation||false;if(c===null){this.bus.trigger("wse.interpreter.warning",{element:a,message:"Element of type 'do' must have an attribute 'asset'. Element ignored."});return}if(d===null){this.bus.trigger("wse.interpreter.warning",{element:a,message:"Element of type 'do' must have an attribute 'action'. Element ignored."});return}if(typeof this.assets[c]==="undefined"||this.assets[c]===null){this.bus.trigger("wse.interpreter.warning",{element:a,message:"Reference to unknown asset '"+c+"'."});return{doNext:true}}if(typeof this.assets[c][d]==="undefined"){this.bus.trigger("wse.interpreter.warning",{element:a,message:"Action '"+d+"' is not defined for asset '"+c+"'."});return{doNext:true}}return this.assets[c][d](a,b)};d.Interpreter.prototype.buildAssets=function(){var a,b,c;this.bus.trigger("wse.assets.loading.started");a=this.story.getElementsByTagName("asset");b=a.length;for(c=0;c<b;c+=1){this.createAsset(a[c])}};d.Interpreter.prototype.createAsset=function(a){var b,c;b=a.getAttribute("name");c=a.getAttribute("type");if(b===null){this.game.bus.trigger("wse.interpreter.error",{element:a,message:"Expected attribute 'name'."});return}if(c===null){this.game.bus.trigger("wse.interpreter.warning",{element:a,message:"Expected attribute 'type' on asset '"+b+"'."});return}if(typeof this.assets[b]!=="undefined"){this.game.bus.trigger("wse.interpreter.warning",{element:a,message:"Trying to override existing asset '"+b+"'."})}switch(c){case"textbox":this.assets[b]=new d.assets.Textbox(a,this.stage,this.bus);break;case"character":this.assets[b]=new d.assets.Character(a,this.stage,this.bus);break;case"imagepack":this.assets[b]=new d.assets.Imagepack(a,this.stage,this.bus);break;case"audio":this.assets[b]=new d.assets.Audio(a,this.bus);break;case"animation":this.assets[b]=new d.assets.Animation(a,this.stage,this.bus,this.assets,this);break;default:this.game.bus.trigger("wse.interpreter.warning",{element:a,message:"Unknown asset type '"+c+"'."});return}};d.assets={};d.assets.mixins={};d.assets.mixins.move=function(a,b){var c,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x;n=this;g=this.element;c=a.getAttribute("x");e=a.getAttribute("y");f=a.getAttribute("z");r=a.getAttribute("duration")||500;s=a.getAttribute("easing")||"sineEaseOut";t=typeof d.fx.easing[s]!==null?d.fx.easing[s]:d.fx.easing.sineEaseOut;x=b.animation===true?true:false;if(c!==null){p=c.replace(/^(-){0,1}[0-9]*/,"");c=parseInt(c,10)}if(e!==null){q=e.replace(/^(-){0,1}[0-9]*/,"");e=parseInt(e,10)}o=a.getAttribute("wait")==="yes"?true:false;u=false;v=false;w=false;if(c===null&&e===null&&f===null){this.bus.trigger("wse.interpreter.warning",{element:a,message:"Can't apply action 'move' to asset '"+this.name+"' because no x, y or z position has been supplied."})}if(c!==null){if(!x){this.bus.trigger("wse.interpreter.numberOfFunctionsToWaitFor.increase")}d.fx.transform(function(a){g.style.left=a+p},g.offsetLeft,c,{onFinish:!x?function(){n.bus.trigger("wse.interpreter.numberOfFunctionsToWaitFor.decrease")}:null,duration:r,easing:t})}if(e!==null){if(!x){this.bus.trigger("wse.interpreter.numberOfFunctionsToWaitFor.increase")}d.fx.transform(function(a){g.style.top=a+q},g.offsetTop,e,{onFinish:!x?function(){n.bus.trigger("wse.interpreter.numberOfFunctionsToWaitFor.decrease")}:null,duration:r,easing:t})}if(f!==null){if(!x){this.bus.trigger("wse.interpreter.numberOfFunctionsToWaitFor.increase")}d.fx.transform(function(a){g.style.zIndex=a},g.style.zIndex||0,parseInt(f,10),{onFinish:!x?function(){n.bus.trigger("wse.interpreter.numberOfFunctionsToWaitFor.decrease")}:null,duration:r,easing:t})}return{doNext:true}};d.assets.mixins.show=function(a,b){var c,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s;b=b||{};c=this;h=a.getAttribute("wait")==="yes"?true:false;e=a.getAttribute("duration")||500;i=a.getAttribute("effect")||"fade";j=a.getAttribute("direction")||"right";p=b.element||this.element;n=b.bus||this.bus;o=b.stage||this.stage;s=a.getAttribute("easing")||"sineEaseOut";r=typeof d.fx.easing[s]!==null?d.fx.easing[s]:d.fx.easing.sineEaseOut;q=b.animation===true?true:false;if(i==="slide"){k=p.offsetLeft;l=p.offsetTop;switch(j){case"left":p.style.left=k+o.offsetWidth+"px";m="left";break;case"right":p.style.left=k-o.offsetWidth+"px";m="left";break;case"top":p.style.top=l+o.offsetHeight+"px";m="top";break;case"bottom":p.style.top=l-o.offsetHeight+"px";m="top";break;default:p.style.left=k-o.offsetWidth+"px";m="left";break}p.style.opacity=1;if(!q){n.trigger("wse.interpreter.numberOfFunctionsToWaitFor.increase")}d.fx.transform(function(a){p.style[m]=a+"px"},m==="left"?p.offsetLeft:p.offsetTop,m==="left"?k:l,{duration:e,onFinish:!q?function(){n.trigger("wse.interpreter.numberOfFunctionsToWaitFor.decrease")}:null,easing:r})}else{if(!q){n.trigger("wse.interpreter.numberOfFunctionsToWaitFor.increase")}d.fx.transform(function(a){p.style.opacity=a},0,1,{duration:e,onFinish:!q?function(){n.trigger("wse.interpreter.numberOfFunctionsToWaitFor.decrease")}:null,easing:r})}return{doNext:true}};d.assets.mixins.hide=function(a,b){var c,e,f,g,h,i,j,k,l,m,n,o;c=this;h=a.getAttribute("wait")==="yes"?true:false;e=a.getAttribute("duration")||500;i=a.getAttribute("effect")||"fade";j=a.getAttribute("direction")||"left";o=b.animation===true?true:false;if(i==="slide"){k=this.element.offsetLeft;l=this.element.offsetTop;this.element.style.opacity=1;switch(j){case"left":m=k-this.stage.offsetWidth;n="left";break;case"right":m=k+this.stage.offsetWidth;n="left";break;case"top":m=l-this.stage.offsetHeight;n="top";break;case"bottom":m=l+this.stage.offsetHeight;n="top";break;default:m=k-this.stage.offsetWidth;n="left";break}if(!o){c.bus.trigger("wse.interpreter.numberOfFunctionsToWaitFor.increase")}d.fx.transform(function(a){c.element.style[n]=a+"px"},n==="left"?k:l,m,{duration:e,onFinish:function(){if(!o){c.bus.trigger("wse.interpreter.numberOfFunctionsToWaitFor.decrease")}c.element.style.opacity=0;switch(j){case"left":case"right":c.element.style.left=k+"px";n="left";break;case"top":case"bottom":c.element.style.top=l+"px";n="top";break;default:c.element.style.left=k+"px";n="left";break}}})}else{if(!o){c.bus.trigger("wse.interpreter.numberOfFunctionsToWaitFor.increase")}d.fx.transform(function(a){c.element.style.opacity=a},1,0,{duration:e,onFinish:function(){if(!o){c.bus.trigger("wse.interpreter.numberOfFunctionsToWaitFor.decrease")}c.element.style.opacity=0}})}return{doNext:true}};d.assets.Character=function(a,b,c){this.asset=a;this.stage=b;this.bus=c};d.assets.Character.prototype.setTextbox=function(a){this.asset.setAttribute("textbox",a.getAttribute("textbox"))};d.assets.Imagepack=function(a,b,c){var e,f,g,h,i,j,k,l,m,n,o;this.stage=b;this.bus=c;this.name=a.getAttribute("name");n=this;f={};e=document.createElement("div");e.style.opacity=0;e.draggable=false;e.setAttribute("class","imagepack");g=a.getElementsByTagName("image");o=function(){n.bus.trigger("wse.assets.loading.decrease")};for(h=0,i=g.length;h<i;h+=1){j=g[h];k=j.getAttribute("name");l=j.getAttribute("src");if(k===null){this.bus.trigger("wse.interpreter.warning",{element:a,message:"Image without name in imagepack '"+this.name+"'."});continue}if(l===null){this.bus.trigger("wse.interpreter.warning",{element:a,message:"Image without src in imagepack '"+this.name+"'."});continue}m=new Image;this.bus.trigger("wse.assets.loading.increase");d.tools.attachEventListener(m,"load",o);m.src=l;m.style.opacity=0;m.style.position="absolute";m.draggable=false;f[k]=m;e.appendChild(m)}e.style.position="absolute";e.style.left=a.getAttribute("x")||0;e.style.top=a.getAttribute("y")||0;e.style.zIndex=a.getAttribute("z")||0;this.element=e;this.images=f;this.current=null;b.appendChild(e)};d.assets.Imagepack.prototype.move=d.assets.mixins.move;d.assets.Imagepack.prototype.show=d.assets.mixins.show;d.assets.Imagepack.prototype.hide=d.assets.mixins.hide;d.assets.Imagepack.prototype.set=function(a,b){var c,e,f,g,h,i;b=b||{};f=this;e=a.getAttribute("image");h=a.getAttribute("duration")||400;i=b.animation===true?true:false;if(e===null){this.bus.trigger("wse.interpreter.warning",{element:a,message:"Missing attribute 'image' on 'do' element referencing imagepack '"+this.name+"'."});return{doNext:true}}c=this.images[e];if(typeof c==="undefined"||c===null){this.bus.trigger("wse.interpreter.warning",{element:a,message:"Unknown image name on 'do' element referencing imagepack '"+this.name+"'."});return{doNext:true}}g=this.current;for(var j in this.images){if(!this.images.hasOwnProperty(j)){if(j!==e){continue}if(this.images[j]===g){this.bus.trigger("wse.interpreter.warning",{element:a,message:"Trying to set the image that is already set on imagepack '"+this.name+"'."});return{doNext:true}}}}if(!i){f.bus.trigger("wse.interpreter.numberOfFunctionsToWaitFor.increase")}d.fx.transform(function(a){c.style.opacity=a},0,1,{duration:h/2,easing:d.fx.easing.linear,onFinish:function(){if(!i){f.bus.trigger("wse.interpreter.numberOfFunctionsToWaitFor.decrease")}}});if(this.current!==null){if(!i){f.bus.trigger("wse.interpreter.numberOfFunctionsToWaitFor.increase")}setTimeout(function(){d.fx.transform(function(a){g.style.opacity=a},1,0,{duration:h,onFinish:function(){if(!i){f.bus.trigger("wse.interpreter.numberOfFunctionsToWaitFor.decrease")}},easing:d.fx.easing.linear})},h/2)}this.current=c;return{doNext:true}};d.assets.Textbox=function(a,b,c){if(!(this instanceof d.assets.Textbox)){return new d.assets.Textbox(a,b,c)}var e,f,g,h,i,j,k,l;this.name=a.getAttribute("name");this.stage=b;this.bus=c;this.type=a.getAttribute("behaviour")||"adv";this.showNames=a.getAttribute("names")==="yes"?true:false;this.nltobr=a.getAttribute("nltobr")==="true"?true:false;if(this.type==="nvl"){this.showNames=false}e=document.createElement("div");f=document.createElement("div");g=document.createElement("div");e.setAttribute("class","textbox");g.setAttribute("class","text");f.setAttribute("class","name");h=a.getAttribute("cssid");if(h){e.setAttribute("id",h)}i=a.getAttribute("x");if(i){e.style.left=i}j=a.getAttribute("y");if(j){e.style.top=j}k=a.getAttribute("width");if(k){e.style.width=k}l=a.getAttribute("height");if(l){e.style.height=l}e.appendChild(f);e.appendChild(g);b.appendChild(e);if(this.showNames===false){f.style.display="none"}this.element=e;this.nameElement=f;this.textElement=g;this.element.style.opacity=0;this.bus.trigger("wse.assets.textbox.created",this)};d.assets.Textbox.prototype.show=d.assets.mixins.show;d.assets.Textbox.prototype.hide=d.assets.mixins.hide;d.assets.Textbox.prototype.move=d.assets.mixins.move;d.assets.Textbox.prototype.put=function(a,b){b=b||null;var c,e,f;c=this.textElement;e=this.nameElement;a=d.tools.textToHtml(a,this.nltobr);if(this.type==="adv"){d.fx.transform(function(a){c.style.opacity=a},1,0,{duration:50});c.innerHTML=""}f="";if(this.showNames===false&&!!b){f=b+": "}if(b===null){b=""}if(this.type==="adv"){setTimeout(function(){c.innerHTML+=f+a;e.innerHTML=b;d.fx.transform(function(a){c.style.opacity=a},0,1,{duration:50})},50)}else{setTimeout(function(){c.innerHTML+="<p>"+f+a+"</p>";e.innerHTML=b},200)}return{doNext:false}};d.assets.Textbox.prototype.clear=function(){this.textElement.innerHTML="";this.nameElement.innerHTML="";return{doNext:true}};d.assets.Audio=function(a,b){var c,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s;c=this;this.au=new Audio;this.bus=b;this.name=a.getAttribute("name");this.tracks={};this.current=null;this.currentIndex=null;this.autopause=a.getAttribute("autopause")==="true"?true:false;this.loop=a.getAttribute("loop")==="true"?true:false;this.fade=a.getAttribute("fade")==="true"?true:false;s=a.getElementsByTagName("track");g=s.length;if(g<1){this.bus.trigger("wse.interpreter.warning",{element:a,message:"No tracks defined for audio element '"+this.name+"'."});return{doNext:true}}for(f=0;f<g;f+=1){j=s[f];e=j.getElementsByTagName("source");i=e.length;if(i<1){this.bus.trigger("wse.interpreter.warning",{element:a,message:"No sources defined for track '"+l+"' in audio element '"+this.name+"'."});continue}k=new Audio;m={};l=j.getAttribute("title");k.preload=true;if(l===null){this.bus.trigger("wse.interpreter.warning",{element:a,message:"No title defined for track '"+l+"' in audio element '"+this.name+"'."});continue}for(h=0;h<i;h+=1){p=e[h];n=p.getAttribute("href");o=p.getAttribute("type");if(n===null){this.bus.trigger("wse.interpreter.warning",{element:a,message:"No href defined for source in track '"+l+"' in audio element '"+this.name+"'."});continue}if(o===null){this.bus.trigger("wse.interpreter.warning",{element:a,message:"No type defined for source in track '"+l+"' in audio element '"+this.name+"'."});continue}m[o]=n}if(k.canPlayType("audio/mpeg")&&typeof m.mp3!=="undefined"){k.src=m.mp3}else{if(typeof m.ogg==="undefined"){this.bus.trigger("wse.interpreter.warning",{element:a,message:"No usable source found for track '"+l+"' in audio element '"+this.name+"'."});continue}k.src=m.ogg}document.body.appendChild(k);this.tracks[l]=k}this.isPlaying=false;this.renewCurrent=function(){var a,b;a=new Audio;b=c.current.src;document.body.removeChild(c.current);a.src=b;c.current=a;c.tracks[c.currentIndex]=a;document.body.appendChild(a)};this.play=function(b){b=b||document.createElement("div");var e=b.getAttribute("fade")==="true"?true:this.fade;if(c.current===null){this.bus.trigger("wse.interpreter.warning",{element:a,message:"No usable source found for track '"+l+"' in audio element '"+this.name+"'."});return}c.stop(b);c.isPlaying=true;if(c.loop===true){d.tools.attachEventListener(c.current,"ended",function(){c.renewCurrent();setTimeout(function(){c.play()},0)})}else{d.tools.attachEventListener(c.current,"ended",function(){c.isPlaying=false})}if(e===true){c.current.volume=0;c.current.play();c.fadeIn()}else{c.current.play()}};this.stop=function(){if(c.current===null){this.bus.trigger("wse.interpreter.warning",{element:a,message:"No track set for audio element '"+this.name+"'."});return}if(c.fade===true){c.fadeOut();setTimeout(function(){c.current.pause();c.currentTime=.1;c.renewCurrent();c.isPlaying=false},1e3)}else{c.current.pause();c.currentTime=.1;c.renewCurrent();c.isPlaying=false}};this.fadeIn=function(){var a,b;b=function(){if(c.current.volume>.99){c.current.volume=1;clearInterval(a);a=null;return}c.current.volume+=.01};a=setInterval(b,5);return a};this.fadeOut=function(){var a,b;b=function(){if(c.current.volume<.01){c.current.volume=0;clearInterval(a);a=null;return}c.current.volume-=.01};a=setInterval(b,5);return};if(this.autopause===false){return}d.tools.attachEventListener(c.stage,"blur",function(){if(c.isPlaying===true){c.fadeOut();setTimeout(function(){c.current.pause()},1e3)}});d.tools.attachEventListener(c.stage,"focus",function(){if(c.isPlaying===true){c.current.play();c.fadeIn()}})};d.assets.Audio.prototype.set=function(a){var b,c,d;d=this;b=a.getAttribute("track");c=this.isPlaying===true&&this.loop===true?true:false;if(typeof this.tracks[b]==="undefined"||this.tracks[b]===null){this.bus.trigger("wse.interpreter.warning",{element:a,message:"Unknown track '"+b+"' in audio element '"+this.name+"'."});return}if(this.isPlaying===true){this.stop()}this.currentIndex=b;this.current=this.tracks[b];if(c===true){if(this.fade===true){setTimeout(function(){d.play()},1010)}else{this.play()}}};d.assets.Animation=function(a,b,c,e,f){var g,h,i,j,k,l,m,n,o,p,q,r,s;if(!(this instanceof d.assets.Animation)){return new d.assets.Animation(a,b,c)}this.stage=b;this.bus=c;this.asset=a;this.name=a.getAttribute("name");this.cbs=[];this.assets=e;o=this;g=this.asset.getElementsByTagName("group");i=g.length;if(i<1){this.bus.trigger("wse.interpreter.warning",{element:a,message:"Animation asset '"+this.name+"' is empty."});return{doNext:true}}q=function(a,b,c,e,f,g){return d.fx.transform(function(b){a.style[e]=b+f},b,c,g)};s=function(a,b,c){var e,g;g=b;e=g.getAttribute("duration");f.runDoCommand(g,{animation:true});if(e!==null){c.push(d.fx.createTimer(e))}};r=function(a,b){var c=b.length;n=l.length;o.cbs.push(function(){var e=[],f,g,h,i,j,k,l,m,p,r,t,u,v;for(p=0;p<n;p+=1){i=a[p];if(typeof i==="undefined"||i===null){continue}k=i.getAttribute("asset");try{j=o.assets[k].element||o.stage}catch(w){continue}t=i.getAttribute("easing");f=parseInt(i.getAttribute("from"),10);g=parseInt(i.getAttribute("to"),10);h=i.getAttribute("unit")||"";l=i.getAttribute("duration")||500;m=i.getAttribute("property");u={};u.duration=l;if(t!==null&&typeof d.fx.easing[t]!=="undefined"&&d.fx.easing[t]!==null){u.easing=d.fx.easing[t]}e.push(q(j,f,g,m,h,u))}for(v=0;v<c;v+=1){s(v,b[v],e)}return e})};for(h=0;h<i;h+=1){j=g[h];l=j.getElementsByTagName("transform");p=j.getElementsByTagName("do");r(l,p)}this.anim=new d.fx.Animation(this.cbs)};d.assets.Animation.prototype.start=function(){this.anim.start()};d.assets.Animation.prototype.stop=function(){this.anim.stop()};d.assets.Rain=function(a,b,c){if(!(this instanceof d.assets.Rain)){return new d.assets.Rain(a,b,c)}this.asset=a;this.stage=b;this.bus=c;this.canvas=new d.fx.canvas.Canvas({width:b.offsetWidth,height:b.offsetHeight})};d.tools={};d.tools.attachEventListener=function(a,b,c){if(a===null||typeof a==="undefined"){return}if(a.addEventListener){a.addEventListener(b,c,false)}else if(a.attachEvent){a.attachEvent("on"+b,c)}};d.tools.removeEventListener=function(a,b,c){if(typeof a==="undefined"||a===null){return}a.removeEventListener(b,c,false)};d.tools.textToHtml=function(a,b){b=b||false;if(!String.prototype.trim){a=a.replace(/^\n/,"");a=a.replace(/\n$/,"")}else{a=a.trim()}a=b===true?a.replace(/\n/g,"<br />"):a;a=a.replace(/\{/g,"<");a=a.replace(/\}/g,">");return a};return d}(typeof Squiddle==="undefined"?false:Squiddle,typeof MO5==="undefined"?false:MO5,typeof STEINBECK==="undefined"?false:STEINBECK)